[
  {
    "name": "replay_projection_excludes_unreferenced_payload_field",
    "input_commands": [
      "DEFINE product FIELDS { \"name\": \"string\", \"price\": \"int\", \"color\": \"string\" }",
      "STORE product FOR user-1 PAYLOAD {\"name\":\"Desk\",\"price\":25,\"color\":\"red\"}",
      "STORE product FOR user-1 PAYLOAD {\"name\":\"Chair\",\"price\":50,\"color\":\"blue\"}",
      "FLUSH",
      "REPLAY product FOR user-1 RETURN [name]"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["Desk", "Chair"] },
      { "kind": "include_none", "value": ["\"color\"", "\"price\""] }
    ]
  },
  {
    "name": "store_without_definition",
    "input_commands": [
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":1,\"status\":\"confirmed\"}"
    ],
    "matcher": {
      "kind": "include",
      "value": "No schema defined"
    }
  },
  {
    "name": "projection_excludes_unreferenced_payload_field",
    "input_commands": [
      "DEFINE product FIELDS { \"name\": \"string\", \"price\": \"int\", \"color\": \"string\" }",
      "STORE product FOR user-1 PAYLOAD {\"name\":\"Desk\",\"price\":25,\"color\":\"red\"}",
      "FLUSH",
      "QUERY product RETURN [name] WHERE price > 10"
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "Desk"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "\"color\""
        ]
      }
    ]
  },
  {
    "name": "store_and_query_enum_eq",
    "input_commands": [
      "DEFINE subscription FIELDS { \"plan\": [\"pro\", \"basic\"] }",
      "STORE subscription FOR user-1 PAYLOAD {\"plan\": \"pro\"}",
      "STORE subscription FOR user-2 PAYLOAD {\"plan\": \"basic\"}",
      "QUERY subscription WHERE plan=\"pro\""
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "user-1"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "user-2"
        ]
      }
    ]
  },
  {
    "name": "store_and_query_enum_neq",
    "input_commands": [
      "DEFINE subscription FIELDS { \"plan\": [\"pro\", \"basic\"] }",
      "STORE subscription FOR user-3 PAYLOAD {\"plan\": \"pro\"}",
      "STORE subscription FOR user-4 PAYLOAD {\"plan\": \"basic\"}",
      "QUERY subscription WHERE plan!=\"basic\""
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "user-3"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "user-4"
        ]
      }
    ]
  },
  {
    "name": "store_with_invalid_enum_value",
    "input_commands": [
      "DEFINE subscription FIELDS { \"plan\": [\"pro\", \"basic\"] }",
      "STORE subscription FOR user-1 PAYLOAD {\"plan\": \"enterprise\"}"
    ],
    "matcher": {
      "kind": "include",
      "value": "does not match expected type"
    }
  },
  {
    "name": "store_with_invalid_payload",
    "input_commands": [
      "DEFINE order_created FIELDS { \"order_id\": \"int\", \"status\": \"string\" }",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\": \"a string\",\"status\":\"confirmed\"}"
    ],
    "matcher": {
      "kind": "include",
      "value": "Field 'order_id' does not match expected type"
    }
  },
  {
    "name": "store_with_missing_field",
    "input_commands": [
      "DEFINE order_created FIELDS { \"order_id\": \"int\", \"status\": \"string\" }",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":1}"
    ],
    "matcher": {
      "kind": "include",
      "value": "Missing field 'status' in payload"
    }
  },
  {
    "name": "store_with_invalid_field_type",
    "input_commands": [
      "DEFINE order_created FIELDS { \"order_id\": \"int\", \"status\": \"string\" }",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":1,\"status\":\"confirmed\", \"invalid_field\": \"a string\"}"
    ],
    "matcher": {
      "kind": "include",
      "value": "Payload contains fields not defined in schema: invalid_field"
    }
  },
  {
    "name": "store_with_optional_field_present",
    "input_commands": [
      "DEFINE order_created FIELDS { \"order_id\": \"int\", \"status\": \"string\", \"optional_field\": \"string | null\" }",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":123, \"status\":\"confirmed\", \"optional_field\":\"a string\"}",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":124, \"status\":\"confirmed\"}",
      "QUERY order_created WHERE status=\"confirmed\""
    ],
    "matcher": {
      "kind": "include_all",
      "value": [
        "123",
        "124"
      ]
    }
  },
  {
    "name": "query_with_optional_field",
    "input_commands": [
      "DEFINE order_created FIELDS { \"order_id\": \"string\", \"status\": \"string\", \"optional_field\": \"string | null\" }",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":\"order-123\", \"status\":\"confirmed\", \"optional_field\":\"a string\"}",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":\"order-124\", \"status\":\"confirmed\"}",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":\"order-125\", \"status\":\"confirmed\"}",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":\"order-126\", \"status\":\"confirmed\", \"optional_field\":\"a string\"}",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":\"order-127\", \"status\":\"confirmed\"}",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":\"order-128\", \"status\":\"confirmed\", \"optional_field\":\"a string\"}",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":\"order-129\", \"status\":\"confirmed\"}",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":\"order-130\", \"status\":\"confirmed\", \"optional_field\":\"a string\"}",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":\"order-131\", \"status\":\"confirmed\", \"optional_field\":\"a string\"}",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":\"order-132\", \"status\":\"confirmed\"}",
      "QUERY order_created WHERE optional_field=\"a string\""
    ],
    "matchers": [
      {
      "kind": "include_all",
      "value": [
        "order-123",
        "order-126",
        "order-128",
        "order-130",
        "order-131"
      ]
    },
    {
      "kind": "include_none",
      "value": [
        "order-124",
        "order-125",
        "order-127",
        "order-129",
        "order-132"
      ]
    }
    ]
  },
  {
    "name": "simple_query_status_confirmed",
    "input_commands": [
      "DEFINE order_created FIELDS { \"order_id\": \"int\", \"status\": \"string\" }",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":1,\"status\":\"confirmed\"}",
      "STORE order_created FOR customer-2 PAYLOAD {\"order_id\":2,\"status\":\"pending\"}",
      "QUERY order_created WHERE status=\"confirmed\""
    ],
    "matcher": {
      "kind": "include_all",
      "value": [
        "\"order_id\":1",
        "\"status\":\"confirmed\""
      ]
    }
  },
  {
    "name": "simple_query_with_mixed_commands",
    "input_commands": [
      "define order_created FIELDS { \"order_id\": \"int\", \"status\": \"string\" }",
      "Store order_created FoR customer-1 PAYLOAD {\"order_id\":123,\"status\":\"confirmed\"}",
      "STORe order_created For customer-2 PAYLOAD {\"order_id\":124,\"status\":\"pending\"}",
      "query order_created WHERE status=\"confirmed\""
    ],
    "matcher": {
      "kind": "include_all",
      "value": [
        "123"
      ]
    }
  },
  {
    "name": "segment_memory_hybrid_query",
    "config": {
      "engine": { "flush_threshold": 1 }
    },
    "input_commands": [
      "DEFINE order_created FIELDS { \"order_id\": \"int\", \"status\": \"string\" }",
      "STORE order_created FOR customer-1 PAYLOAD {\"order_id\":1,\"status\":\"confirmed\"}",
      "STORE order_created FOR customer-2 PAYLOAD {\"order_id\":2,\"status\":\"confirmed\"}",
      "STORE order_created FOR customer-3 PAYLOAD {\"order_id\":3,\"status\":\"confirmed\"}",
      "STORE order_created FOR customer-4 PAYLOAD {\"order_id\":4,\"status\":\"confirmed\"}",
      "STORE order_created FOR customer-5 PAYLOAD {\"order_id\":5,\"status\":\"pending\"}",
      "STORE order_created FOR customer-6 PAYLOAD {\"order_id\":6,\"status\":\"pending\"}",
      "STORE order_created FOR customer-7 PAYLOAD {\"order_id\":7,\"status\":\"confirmed\"}",
      "SLEEP 1000",
      "QUERY order_created WHERE status=\"confirmed\""
    ],
    "matcher": {
      "kind": "include_all",
      "value": [
        "customer-1",
        "customer-2",
        "customer-3",
        "customer-4",
        "customer-7"
      ]
    }
  },
  {
    "name": "multi_context_query",
    "input_commands": [
      "DEFINE login FIELDS { \"device\": \"string\" }",
      "STORE login FOR user-1 PAYLOAD {\"device\":\"android\"} ",
      "STORE login FOR user-2 PAYLOAD {\"device\":\"android\"} ",
      "STORE login FOR user-3 PAYLOAD {\"device\":\"web\"} ",
      "STORE login FOR user-4 PAYLOAD {\"device\":\"android\"} ",
      "QUERY login WHERE device=\"android\""
    ],
    "matcher": {
      "kind": "include_all",
      "value": [
        "user-1",
        "user-2",
        "user-4"
      ]
    }
  },
  {
    "name": "replay_from_segment",
    "input_commands": [
      "DEFINE order_shipped FIELDS { \"order_id\": \"int\", \"status\": \"string\" }",
      "STORE order_shipped FOR customer-99 PAYLOAD {\"order_id\":999,\"status\":\"shipped\"}",
      "STORE order_shipped FOR customer-99 PAYLOAD {\"order_id\":1000,\"status\":\"delivered\"}",
      "STORE order_shipped FOR customer-99 PAYLOAD {\"order_id\":1001,\"status\":\"delivered\"}",
      "STORE order_shipped FOR customer-100 PAYLOAD {\"order_id\":1002,\"status\":\"returned\"}",
      "FLUSH",
      "REPLAY order_shipped FOR customer-99"
    ],
    "matchers": [
      {
      "kind": "include_all",
      "value": [
        "\"order_id\":999",
        "\"order_id\":1000",
        "\"order_id\":1001"
      ]
    },
    {
      "kind": "include_none",
      "value": [
        "1002"
      ]
    }
    ]
  },
  {
    "name": "replay_mixed_context",
    "input_commands": [
      "DEFINE login FIELDS { \"device\": \"string\" }",
      "STORE login FOR alice PAYLOAD {\"device\":\"android\"}",
      "STORE login FOR alice PAYLOAD {\"device\":\"web\"}",
      "STORE login FOR bob PAYLOAD {\"device\":\"iphone\"}",
      "REPLAY FOR alice"
    ],
    "matchers": [
      {
      "kind": "include_all",
      "value": [
        "android",
        "web"
      ]
    },
    {
      "kind": "include_none",
      "value": [
        "bob"
      ]
    }
    ]
  },
  {
    "name": "query_on_boolean_flag",
    "input_commands": [
      "DEFINE review FIELDS { \"rating\": \"int\", \"verified\": \"bool\" }",
      "STORE review FOR u1 PAYLOAD {\"rating\":5,\"verified\":true}",
      "STORE review FOR u2 PAYLOAD {\"rating\":4,\"verified\":false}",
      "QUERY review WHERE verified=true"
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "u1"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "u2"
        ]
      }
    ]
  },
  {
    "name": "query_in_memory_only",
    "input_commands": [
      "DEFINE cart_updated FIELDS { \"sku\": \"string\", \"qty\": \"int\" }",
      "STORE cart_updated FOR user-1 PAYLOAD {\"sku\":\"ABC123\",\"qty\":2}",
      "QUERY cart_updated WHERE sku=\"ABC123\""
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "ABC123"
        ]
      }
    ]
  },
  {
    "name": "replay_nonexistent_context",
    "input_commands": [
      "REPLAY FOR ghost-user"
    ],
    "matcher": {
      "kind": "include",
      "value": "No matching events found"
    }
  },
  {
    "name": "replay_context_post_flush",
    "input_commands": [
      "DEFINE order_returned FIELDS { \"order_id\": \"int\", \"reason\": \"string\" }",
      "STORE order_returned FOR user-2 PAYLOAD {\"order_id\":991,\"reason\":\"broken\"}",
      "STORE order_returned FOR user-2 PAYLOAD {\"order_id\":992,\"reason\":\"wrong_size\"}",
      "STORE order_returned FOR user-2 PAYLOAD {\"order_id\":993,\"reason\":\"changed_mind\"}",
      "STORE order_returned FOR user-2 PAYLOAD {\"order_id\":994,\"reason\":\"late_delivery\"}",
      "FLUSH",
      "REPLAY order_returned FOR user-2"
    ],
    "matcher": {
      "kind": "include_all",
      "value": [
        "991",
        "992",
        "993",
        "994"
      ]
    }
  },
  {
    "name": "query_empty_event_type",
    "input_commands": [
      "QUERY nonexistent_type WHERE id=42"
    ],
    "matcher": {
      "kind": "include",
      "value": "No matching events found"
    }
  },
  {
    "name": "query_filter_single_match",
    "input_commands": [
      "DEFINE order_created FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_created FOR user-1 PAYLOAD {\"id\":1,\"country\":\"NL\"}",
      "FLUSH",
      "QUERY order_created WHERE country=\"NL\""
    ],
    "matcher": {
      "kind": "include_all",
      "value": [
        "user-1"
      ]
    }
  },
  {
    "name": "query_with_no_match",
    "input_commands": [
      "DEFINE order_created FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_created FOR user-2 PAYLOAD {\"id\":2,\"country\":\"DE\"}",
      "FLUSH",
      "QUERY order_created WHERE country=\"NL\""
    ],
    "matcher": {
      "kind": "include",
      "value": "No matching events found"
    }
  },
  {
    "name": "query_multiple_matches",
    "input_commands": [
      "DEFINE order_created FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_created FOR user-3 PAYLOAD {\"id\":3,\"country\":\"NL\"} ",
      "STORE order_created FOR user-4 PAYLOAD {\"id\":4,\"country\":\"NL\"} ",
      "QUERY order_created WHERE country=\"NL\""
    ],
    "matcher": {
      "kind": "include_all",
      "value": [
        "user-3",
        "user-4"
      ]
    }
  },
  {
    "name": "query_multiple_shards",
    "input_commands": [
      "DEFINE order_created FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_created FOR user-7 PAYLOAD {\"id\":7,\"country\":\"NL\"}",
      "STORE order_created FOR user-8 PAYLOAD {\"id\":8,\"country\":\"DE\"}",
      "STORE order_created FOR user-9 PAYLOAD {\"id\":9,\"country\":\"NL\"}",
      "FLUSH",
      "QUERY order_created WHERE country=\"NL\""
    ],
    "matcher": {
      "kind": "include_all",
      "value": [
        "user-7",
        "user-9"
      ]
    }
  },
  {
    "name": "query_mixed_conditions",
    "input_commands": [
      "DEFINE order_created FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_created FOR user-10 PAYLOAD {\"id\":10,\"country\":\"NL\"}",
      "STORE order_created FOR user-11 PAYLOAD {\"id\":11,\"country\":\"FR\"}",
      "STORE order_created FOR user-12 PAYLOAD {\"id\":12,\"country\":\"FR\"}",
      "QUERY order_created WHERE country=\"FR\" AND id > 11"
    ],
    "matchers": [
      {
      "kind": "include_all",
      "value": [
        "user-12"
      ]
    },
    {
      "kind": "include_none",
      "value": [
        "user-10",
        "user-11"
      ]
    }
    ]
  },
  {
    "name": "query_after_multiple_flushes",
    "input_commands": [
      "DEFINE order_create_1 FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_create_1 FOR user-12 PAYLOAD {\"id\":12,\"country\":\"DE\"}",
      "FLUSH",
      "STORE order_create_1 FOR user-13 PAYLOAD {\"id\":13,\"country\":\"NL\"}",
      "FLUSH",
      "QUERY order_create_1 WHERE country=NL"
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "user-13"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "user-12"
        ]
      }
    ]
  },
  {
    "name": "query_with_inequality",
    "input_commands": [
      "DEFINE order_created FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_created FOR user-13 PAYLOAD {\"id\":13,\"country\":\"NL\"}",
      "STORE order_created FOR user-14 PAYLOAD {\"id\":14,\"country\":\"FR\"}",
      "QUERY order_created WHERE country!=\"NL\""
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "user-14"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "user-13"
        ]
      }
    ]
  },
  {
    "name": "query_with_not",
    "input_commands": [
      "DEFINE order_created FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_created FOR user-13 PAYLOAD {\"id\":13,\"country\":\"NL\"}",
      "STORE order_created FOR user-14 PAYLOAD {\"id\":14,\"country\":\"FR\"}",
      "QUERY order_created WHERE NOT country=\"NL\""
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "user-14"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "user-13"
        ]
      }
    ]
  },
  {
    "name": "query_with_or",
    "input_commands": [
      "DEFINE order_created FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_created FOR user-13 PAYLOAD {\"id\":13,\"country\":\"NL\"}",
      "STORE order_created FOR user-14 PAYLOAD {\"id\":14,\"country\":\"FR\"}",
      "STORE order_created FOR user-15 PAYLOAD {\"id\":15,\"country\":\"DE\"}",
      "QUERY order_created WHERE country=\"NL\" OR country=\"FR\""
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "user-13",
          "user-14"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "user-15"
        ]
      }
    ]
  },
  {
    "name": "query_with_greater_than_or_equal",
    "input_commands": [
      "DEFINE order_created FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_created FOR user-13 PAYLOAD {\"id\":13,\"country\":\"NL\"}",
      "STORE order_created FOR user-14 PAYLOAD {\"id\":14,\"country\":\"FR\"}",
      "STORE order_created FOR user-15 PAYLOAD {\"id\":15,\"country\":\"DE\"}",
      "QUERY order_created WHERE id >= 14"
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "user-14",
          "user-15"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "user-13"
        ]
      }
    ]
  },
  {
    "name": "query_with_less_than_or_equal",
    "input_commands": [
      "DEFINE order_created FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_created FOR user-13 PAYLOAD {\"id\":13,\"country\":\"NL\"}",
      "STORE order_created FOR user-14 PAYLOAD {\"id\":14,\"country\":\"FR\"}",
      "STORE order_created FOR user-15 PAYLOAD {\"id\":15,\"country\":\"DE\"}",
      "QUERY order_created WHERE id <= 14"
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "user-13",
          "user-14"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "user-15"
        ]
      }
    ]
  },
  {
    "name": "query_with_logical_operators",
    "input_commands": [
      "DEFINE order_created FIELDS { \"id\": \"int\", \"country\": \"string\" }",
      "STORE order_created FOR user-13 PAYLOAD {\"id\":13,\"country\":\"NL\"}",
      "STORE order_created FOR user-14 PAYLOAD {\"id\":14,\"country\":\"FR\"}",
      "STORE order_created FOR user-15 PAYLOAD {\"id\":15,\"country\":\"DE\"}",
      "FLUSH",
      "QUERY order_created WHERE id > 13 AND id < 15"
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "user-14"
        ]
      }
    ]
  }
  ,
  {
    "name": "query_limit_zero_no_results",
    "input_commands": [
      "DEFINE limit_zero FIELDS { \"status\": \"string\" }",
      "STORE limit_zero FOR a PAYLOAD {\"status\":\"ok\"}",
      "STORE limit_zero FOR b PAYLOAD {\"status\":\"ok\"}",
      "QUERY limit_zero WHERE status=\"ok\" LIMIT 0"
    ],
    "matcher": { "kind": "include", "value": "No matching events found" }
  }
  ,
  {
    "name": "query_limit_memtable_only_two",
    "config": { "engine": { "flush_threshold": 100 } },
    "input_commands": [
      "DEFINE limit_mem_only FIELDS { \"status\": \"string\" }",
      "STORE limit_mem_only FOR u1 PAYLOAD {\"status\":\"ok\"}",
      "STORE limit_mem_only FOR u2 PAYLOAD {\"status\":\"ok\"}",
      "STORE limit_mem_only FOR u3 PAYLOAD {\"status\":\"ok\"}",
      "QUERY limit_mem_only WHERE status=\"ok\" LIMIT 2"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["u2","u3"] },
      { "kind": "include_none", "value": ["u1"] }
    ]
  }
  ,
  {
    "name": "query_limit_memtable_only_two_same_shard",
    "config": { "engine": { "flush_threshold": 100 } },
    "input_commands": [
      "DEFINE limit_mem_only FIELDS { \"status\": \"int\" }",
      "STORE limit_mem_only FOR u1 PAYLOAD {\"status\":400}",
      "STORE limit_mem_only FOR u1 PAYLOAD {\"status\":500}",
      "STORE limit_mem_only FOR u1 PAYLOAD {\"status\":200}",
      "QUERY limit_mem_only LIMIT 2"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"status\":400","\"status\":500"] },
      { "kind": "include_none", "value": ["\"status\":200"] }
    ]
  }
  ,
  {
    "name": "query_limit_combines_memtable_and_segment",
    "input_commands": [
      "DEFINE limit_mix FIELDS { \"status\": \"string\" }",
      "STORE limit_mix FOR seg-ctx PAYLOAD {\"status\":\"ok\"}",
      "FLUSH",
      "STORE limit_mix FOR mem-ctx PAYLOAD {\"status\":\"ok\"}",
      "QUERY limit_mix WHERE status=\"ok\" LIMIT 2"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["seg-ctx","mem-ctx"] }
    ]
  }
  ,
  {
    "name": "query_limit_equal_to_total",
    "config": { "engine": { "flush_threshold": 100 } },
    "input_commands": [
      "DEFINE limit_eq_total FIELDS { \"status\": \"string\" }",
      "STORE limit_eq_total FOR c1 PAYLOAD {\"status\":\"ok\"}",
      "STORE limit_eq_total FOR c2 PAYLOAD {\"status\":\"ok\"}",
      "STORE limit_eq_total FOR c3 PAYLOAD {\"status\":\"ok\"}",
      "QUERY limit_eq_total WHERE status=\"ok\" LIMIT 3"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["c1","c2","c3"] }
    ]
  }
  ,
  {
    "name": "query_limit_greater_than_total",
    "config": { "engine": { "flush_threshold": 100 } },
    "input_commands": [
      "DEFINE limit_gt_total FIELDS { \"status\": \"string\" }",
      "STORE limit_gt_total FOR d1 PAYLOAD {\"status\":\"ok\"}",
      "STORE limit_gt_total FOR d2 PAYLOAD {\"status\":\"ok\"}",
      "QUERY limit_gt_total WHERE status=\"ok\" LIMIT 10"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["d1","d2"] }
    ]
  }
  ,
  {
    "name": "replay_since_using_created_at_iso8601",
    "input_commands": [
      "DEFINE evt_rp1 FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_rp1 FOR rctx PAYLOAD {\"id\":1,\"created_at\":\"2025-01-01T00:00:00Z\"}",
      "STORE evt_rp1 FOR rctx PAYLOAD {\"id\":2,\"created_at\":\"2025-01-01T00:00:01Z\"}",
      "FLUSH",
      "REPLAY evt_rp1 FOR rctx SINCE \"2025-01-01T00:00:01Z\" USING created_at"
    ],
    "matchers": [
      { "kind": "include", "value": "\"id\":2" },
      { "kind": "include_none", "value": ["\"id\":1"] }
    ]
  }
  ,
  {
    "name": "replay_since_using_created_at_ms",
    "input_commands": [
      "DEFINE evt_rp2 FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_rp2 FOR rctx2 PAYLOAD {\"id\":1,\"created_at\":\"2025-01-01T00:00:00Z\"}",
      "STORE evt_rp2 FOR rctx2 PAYLOAD {\"id\":2,\"created_at\":\"2025-01-01T00:00:01Z\"}",
      "FLUSH",
      "REPLAY evt_rp2 FOR rctx2 SINCE \"1735689600000\" USING created_at"
    ],
    "matcher": { "kind": "include_all", "value": ["\"id\":1","\"id\":2"] }
  }
  ,
  {
    "name": "replay_since_using_date_field_midnight",
    "input_commands": [
      "DEFINE evt_rp3 FIELDS { \"id\": \"int\", \"on\": \"date\" }",
      "STORE evt_rp3 FOR rctx3 PAYLOAD {\"id\":1,\"on\":\"2025-01-01\"}",
      "STORE evt_rp3 FOR rctx3 PAYLOAD {\"id\":2,\"on\":\"2025-01-02\"}",
      "FLUSH",
      "REPLAY evt_rp3 FOR rctx3 SINCE \"2025-01-02T00:00:00Z\" USING on"
    ],
    "matcher": { "kind": "include", "value": "\"id\":2" }
  }
  ,
  {
    "name": "replay_since_unparsable_ignored",
    "input_commands": [
      "DEFINE evt_rp4 FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_rp4 FOR rctx4 PAYLOAD {\"id\":1,\"created_at\":\"2025-01-01T00:00:00Z\"}",
      "STORE evt_rp4 FOR rctx4 PAYLOAD {\"id\":2,\"created_at\":\"2025-01-01T00:00:01Z\"}",
      "FLUSH",
      "REPLAY evt_rp4 FOR rctx4 SINCE \"bogus\" USING created_at"
    ],
    "matcher": { "kind": "include_all", "value": ["\"id\":1","\"id\":2"] }
  },
  {
    "name": "bucket_month_using_created_at_boundary",
    "input_commands": [
      "DEFINE orders_time FIELDS { \"id\": \"int\", \"created_at\": \"datetime\", \"amount\": \"int\" }",
      "STORE orders_time FOR b1 PAYLOAD {\"id\":1,\"created_at\":1736639999,\"amount\":10}",
      "STORE orders_time FOR b2 PAYLOAD {\"id\":2,\"created_at\":1736640000,\"amount\":20}",
      "FLUSH",
      "QUERY orders_time TOTAL amount PER month USING created_at"
    ],
    "matchers": [
      { "kind": "include", "value": "\"bucket\"" },
      { "kind": "include_all", "value": ["1734048000","1736640000"] },
      { "kind": "include_all", "value": ["10","20"] }
    ]
  }
  ,
  {
    "name": "bucket_week_using_created_at_negative_offset_cross_week",
    "input_commands": [
      "DEFINE sessions FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE sessions FOR s1 PAYLOAD {\"id\":1,\"created_at\":1735171199}",
      "STORE sessions FOR s2 PAYLOAD {\"id\":2,\"created_at\":1735171200}",
      "FLUSH",
      "QUERY sessions COUNT PER week USING created_at"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["[1734566400,1]","[1735171200,1]"] }
    ]
  }
  ,
  {
    "name": "bucket_day_using_date_field_midnight_normalization",
    "input_commands": [
      "DEFINE birthdays FIELDS { \"id\": \"int\", \"birthdate\": \"date\" }",
      "STORE birthdays FOR bd1 PAYLOAD {\"id\":1,\"birthdate\":\"2025-09-06\"}",
      "STORE birthdays FOR bd2 PAYLOAD {\"id\":2,\"birthdate\":\"2025-09-06\"}",
      "STORE birthdays FOR bd3 PAYLOAD {\"id\":3,\"birthdate\":\"2025-09-07\"}",
      "FLUSH",
      "QUERY birthdays COUNT PER day USING birthdate"
    ],
    "matchers": [
      { "kind": "include", "value": "\"count\"" },
      { "kind": "include", "value": "2" },
      { "kind": "include", "value": "1" }
    ]
  }
  ,
  {
    "name": "bucket_hour_using_created_at_ms_payload",
    "input_commands": [
      "DEFINE clicks FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE clicks FOR c1 PAYLOAD {\"id\":1,\"created_at\":1735689600000}",
      "STORE clicks FOR c2 PAYLOAD {\"id\":2,\"created_at\":1735693199000}",
      "STORE clicks FOR c3 PAYLOAD {\"id\":3,\"created_at\":1735693200000}",
      "FLUSH",
      "QUERY clicks COUNT PER hour USING created_at"
    ],
    "matchers": [
      { "kind": "include", "value": "\"count\"" },
      { "kind": "include", "value": "2" },
      { "kind": "include", "value": "1" }
    ]
  },
  {
    "name": "since_using_created_at_equal_boundary_included",
    "input_commands": [
      "DEFINE evt_eq FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_eq FOR ctxEq PAYLOAD {\"id\":1,\"created_at\":\"2024-12-31T23:59:59Z\"}",
      "STORE evt_eq FOR ctxEq PAYLOAD {\"id\":2,\"created_at\":\"2025-01-01T00:00:00Z\"}",
      "FLUSH",
      "QUERY evt_eq FOR ctxEq SINCE \"2025-01-01T00:00:00Z\" USING created_at"
    ],
    "matchers": [
      { "kind": "include", "value": "\"id\":2" },
      { "kind": "include_none", "value": ["\"id\":1"] }
    ]
  }
  ,
  {
    "name": "since_using_created_at_ms_input",
    "input_commands": [
      "DEFINE evt_ms FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_ms FOR ctxMs PAYLOAD {\"id\":1,\"created_at\":\"2025-01-01T00:00:00Z\"}",
      "STORE evt_ms FOR ctxMs PAYLOAD {\"id\":2,\"created_at\":\"2025-01-01T00:00:01Z\"}",
      "FLUSH",
      "QUERY evt_ms FOR ctxMs SINCE \"1735689600000\" USING created_at"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"id\":1","\"id\":2"] }
    ]
  }
  ,
  {
    "name": "since_using_created_at_ns_input_excludes_first",
    "input_commands": [
      "DEFINE evt_ns FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_ns FOR ctxNs PAYLOAD {\"id\":1,\"created_at\":\"2025-01-01T00:00:00Z\"}",
      "STORE evt_ns FOR ctxNs PAYLOAD {\"id\":2,\"created_at\":\"2025-01-01T00:00:01Z\"}",
      "FLUSH",
      "QUERY evt_ns FOR ctxNs SINCE \"1735689601000000000\" USING created_at"
    ],
    "matchers": [
      { "kind": "include", "value": "\"id\":2" },
      { "kind": "include_none", "value": ["\"id\":1"] }
    ]
  }
  ,
  {
    "name": "since_using_created_at_minus_offset_boundary",
    "input_commands": [
      "DEFINE evt_neg_off FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_neg_off FOR ctxNo PAYLOAD {\"id\":1,\"created_at\":\"2024-12-31T18:59:59-05:00\"}",
      "STORE evt_neg_off FOR ctxNo PAYLOAD {\"id\":2,\"created_at\":\"2024-12-31T19:00:00-05:00\"}",
      "FLUSH",
      "QUERY evt_neg_off FOR ctxNo SINCE \"2025-01-01T00:00:00Z\" USING created_at"
    ],
    "matchers": [
      { "kind": "include", "value": "\"id\":2" },
      { "kind": "include_none", "value": ["\"id\":1"] }
    ]
  }
  ,
  {
    "name": "store_created_at_ms_number_normalized",
    "input_commands": [
      "DEFINE evt_store_ms FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_store_ms FOR ctxSm PAYLOAD {\"id\":1,\"created_at\":1735689600000}",
      "STORE evt_store_ms FOR ctxSm PAYLOAD {\"id\":2,\"created_at\":1735689601000}",
      "FLUSH",
      "QUERY evt_store_ms FOR ctxSm SINCE \"2025-01-01T00:00:00Z\" USING created_at"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"id\":1","\"id\":2"] }
    ]
  },
  {
    "name": "since_using_created_at_with_offset",
    "input_commands": [
      "DEFINE evt_off FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_off FOR ctxO PAYLOAD {\"id\":1,\"created_at\":\"2025-01-01T01:59:59+02:00\"}",
      "STORE evt_off FOR ctxO PAYLOAD {\"id\":2,\"created_at\":\"2025-01-01T02:00:01+02:00\"}",
      "FLUSH",
      "QUERY evt_off FOR ctxO SINCE \"2025-01-01T00:00:00Z\" USING created_at"
    ],
    "matchers": [
      { "kind": "include", "value": "\"id\":2" },
      { "kind": "include_none", "value": ["\"id\":1"] }
    ]
  }
  ,
  {
    "name": "since_using_date_field",
    "input_commands": [
      "DEFINE people FIELDS { \"id\": \"int\", \"birthdate\": \"date\" }",
      "STORE people FOR pctx PAYLOAD {\"id\":1,\"birthdate\":\"2025-09-06\"}",
      "STORE people FOR pctx PAYLOAD {\"id\":2,\"birthdate\":\"2025-09-07\"}",
      "FLUSH",
      "QUERY people FOR pctx SINCE \"2025-09-07T00:00:00Z\" USING birthdate"
    ],
    "matchers": [
      { "kind": "include", "value": "\"id\":2" },
      { "kind": "include_none", "value": ["\"id\":1"] }
    ]
  }
  ,
  {
    "name": "store_invalid_time_string_rejected",
    "input_commands": [
      "DEFINE evt_bad_time FIELDS { \"created_at\": \"datetime\" }",
      "STORE evt_bad_time FOR ctxBad PAYLOAD {\"created_at\":\"not-a-time\"}"
    ],
    "matcher": { "kind": "include", "value": "Invalid time string" }
  }
  ,
  {
    "name": "since_unparsable_ignored_includes_all",
    "input_commands": [
      "DEFINE evt_bogus FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_bogus FOR ctxBog PAYLOAD {\"id\":1,\"created_at\":\"2025-01-01T00:00:01Z\"}",
      "STORE evt_bogus FOR ctxBog PAYLOAD {\"id\":2,\"created_at\":\"2025-01-02T00:00:00Z\"}",
      "FLUSH",
      "QUERY evt_bogus FOR ctxBog SINCE \"bogus\" USING created_at"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"id\":1","\"id\":2"] }
    ]
  }
  ,
  {
    "name": "since_using_optional_datetime_skips_nulls",
    "input_commands": [
      "DEFINE evt_opt_time FIELDS { \"id\": \"int\", \"created_at\": \"datetime | null\" }",
      "STORE evt_opt_time FOR ctxOpt PAYLOAD {\"id\":1,\"created_at\":null}",
      "STORE evt_opt_time FOR ctxOpt PAYLOAD {\"id\":2,\"created_at\":\"2025-01-02T00:00:00Z\"}",
      "FLUSH",
      "QUERY evt_opt_time FOR ctxOpt SINCE \"2025-01-01T00:00:00Z\" USING created_at"
    ],
    "matchers": [
      { "kind": "include", "value": "\"id\":2" },
      { "kind": "include_none", "value": ["\"id\":1"] }
    ]
  },
  {
    "name": "since_using_created_at_iso8601_selection",
    "input_commands": [
      "DEFINE evt_time_sel1 FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_time_sel1 FOR ctxA PAYLOAD {\"id\":1,\"created_at\":\"2024-12-31T23:59:59Z\"}",
      "STORE evt_time_sel1 FOR ctxA PAYLOAD {\"id\":2,\"created_at\":\"2025-01-01T00:00:01Z\"}",
      "FLUSH",
      "QUERY evt_time_sel1 FOR ctxA SINCE \"2025-01-01T00:00:00Z\" USING created_at"
    ],
    "matchers": [
      { "kind": "include", "value": "\"id\":2" },
      { "kind": "include_none", "value": ["\"id\":1"] }
    ]
  }
  ,
  {
    "name": "since_using_created_at_numeric_units_selection",
    "input_commands": [
      "DEFINE evt_time_sel2 FIELDS { \"id\": \"int\", \"created_at\": \"datetime\" }",
      "STORE evt_time_sel2 FOR ctxB PAYLOAD {\"id\":1,\"created_at\":1600000000000}",
      "STORE evt_time_sel2 FOR ctxB PAYLOAD {\"id\":2,\"created_at\":1600000100000}",
      "FLUSH",
      "QUERY evt_time_sel2 FOR ctxB SINCE \"1600000000\" USING created_at"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"id\":1","\"id\":2"] }
    ]
  }
  ,
  {
    "name": "agg_count_per_day_by_country_and_plan",
    "input_commands": [
      "DEFINE orders FIELDS { \"amount\": \"int\", \"country\": \"string\", \"plan\": \"string\" }",
      "STORE orders FOR c1 PAYLOAD {\"amount\":10,\"country\":\"NL\",\"plan\":\"pro\"}",
      "STORE orders FOR c2 PAYLOAD {\"amount\":20,\"country\":\"NL\",\"plan\":\"basic\"}",
      "STORE orders FOR c3 PAYLOAD {\"amount\":15,\"country\":\"DE\",\"plan\":\"pro\"}",
      "STORE orders FOR c4 PAYLOAD {\"amount\":18,\"country\":\"NL\",\"plan\":\"pro\"}",
      "STORE orders FOR c5 PAYLOAD {\"amount\":11,\"country\":\"NL\",\"plan\":\"basic\"}",
      "FLUSH",
      "QUERY orders COUNT PER day BY country, plan"
    ],
    "matchers": [
      { "kind": "include", "value": "\"NL\",\"basic\",2" },
      { "kind": "include", "value": "\"NL\",\"pro\",2" },
      { "kind": "include", "value": "\"DE\",\"pro\",1" }
    ]
  }
  ,
  {
    "name": "agg_count_unique_user_by_country_per_week",
    "input_commands": [
      "DEFINE login FIELDS { \"user_id\": \"string\", \"country\": \"string\" }",
      "STORE login FOR u1 PAYLOAD {\"user_id\":\"A\",\"country\":\"NL\"}",
      "STORE login FOR u2 PAYLOAD {\"user_id\":\"B\",\"country\":\"DE\"}",
      "STORE login FOR u3 PAYLOAD {\"user_id\":\"A\",\"country\":\"NL\"}",
      "FLUSH",
      "QUERY login COUNT UNIQUE user_id PER week BY country"
    ],
    "matchers": [
      { "kind": "include", "value": "\"count_unique_user_id\"" },
      { "kind": "include", "value": "\"NL\",1" },
      { "kind": "include", "value": "\"DE\",1" }
    ]
  }
  ,
  {
    "name": "agg_avg_min_max_with_filter_by_country",
    "input_commands": [
      "DEFINE orders FIELDS { \"amount\": \"int\", \"country\": \"string\", \"status\": \"string\" }",
      "STORE orders FOR c1 PAYLOAD {\"amount\":10,\"country\":\"NL\",\"status\":\"ok\"}",
      "STORE orders FOR c2 PAYLOAD {\"amount\":30,\"country\":\"NL\",\"status\":\"ok\"}",
      "STORE orders FOR c3 PAYLOAD {\"amount\":25,\"country\":\"DE\",\"status\":\"pending\"}",
      "FLUSH",
      "QUERY orders WHERE status=\"ok\" AVG amount, MIN amount, MAX amount BY country"
    ],
    "matchers": [
      { "kind": "include", "value": "\"avg_amount\"" },
      { "kind": "include", "value": "\"min_amount\"" },
      { "kind": "include", "value": "\"max_amount\"" },
      { "kind": "include", "value": "\"NL\"" },
      { "kind": "include", "value": "20.0" },
      { "kind": "include", "value": "10" },
      { "kind": "include", "value": "30" }
    ]
  }
  ,
  {
    "name": "agg_total_amount_group_by_two_fields_no_bucket",
    "input_commands": [
      "DEFINE orders FIELDS { \"amount\": \"int\", \"region\": \"string\", \"channel\": \"string\" }",
      "STORE orders FOR r1 PAYLOAD {\"amount\":5,\"region\":\"EU\",\"channel\":\"web\"}",
      "STORE orders FOR r2 PAYLOAD {\"amount\":7,\"region\":\"EU\",\"channel\":\"store\"}",
      "STORE orders FOR r3 PAYLOAD {\"amount\":9,\"region\":\"US\",\"channel\":\"web\"}",
      "FLUSH",
      "QUERY orders TOTAL amount BY region, channel"
    ],
    "matchers": [
      { "kind": "include", "value": "\"EU\",\"web\",5" },
      { "kind": "include", "value": "\"EU\",\"store\",7" },
      { "kind": "include", "value": "\"US\",\"web\",9" }
    ]
  }
  ,
  {
    "name": "agg_count_and_avg_per_hour_by_region",
    "input_commands": [
      "DEFINE metrics FIELDS { \"value\": \"int\", \"region\": \"string\" }",
      "STORE metrics FOR m1 PAYLOAD {\"value\":1,\"region\":\"EU\"}",
      "STORE metrics FOR m2 PAYLOAD {\"value\":3,\"region\":\"EU\"}",
      "STORE metrics FOR m3 PAYLOAD {\"value\":2,\"region\":\"US\"}",
      "FLUSH",
      "QUERY metrics COUNT, AVG value PER hour BY region"
    ],
    "matchers": [
      { "kind": "include", "value": "\"EU\",2,2.0" },
      { "kind": "include", "value": "\"US\",1,2.0" }
    ]
  }
  ,
  {
    "name": "agg_count_and_count_unique_by_country",
    "input_commands": [
      "DEFINE login FIELDS { \"user_id\": \"string\", \"country\": \"string\" }",
      "STORE login FOR a PAYLOAD {\"user_id\":\"X\",\"country\":\"NL\"}",
      "STORE login FOR b PAYLOAD {\"user_id\":\"Y\",\"country\":\"NL\"}",
      "STORE login FOR c PAYLOAD {\"user_id\":\"X\",\"country\":\"NL\"}",
      "FLUSH",
      "QUERY login COUNT, COUNT UNIQUE user_id BY country"
    ],
    "matchers": [
      { "kind": "include", "value": "\"count\"" },
      { "kind": "include", "value": "\"count_unique_user_id\"" },
      { "kind": "include", "value": "\"NL\",3,2" }
    ]
  },
  {
    "name": "agg_count_all_simple",
    "input_commands": [
      "DEFINE evt FIELDS { \"v\": \"int\" }",
      "STORE evt FOR a PAYLOAD {\"v\":1}",
      "STORE evt FOR b PAYLOAD {\"v\":2}",
      "FLUSH",
      "QUERY evt COUNT"
    ],
    "matcher": { "kind": "include", "value": "\"rows\":[[2]]" }
  }
  ,
  {
    "name": "agg_count_unique_by_country",
    "input_commands": [
      "DEFINE login FIELDS { \"user_id\": \"string\", \"country\": \"string\" }",
      "STORE login FOR u1 PAYLOAD {\"user_id\":\"A\",\"country\":\"NL\"}",
      "STORE login FOR u2 PAYLOAD {\"user_id\":\"B\",\"country\":\"DE\"}",
      "STORE login FOR u3 PAYLOAD {\"user_id\":\"A\",\"country\":\"NL\"}",
      "FLUSH",
      "QUERY login COUNT UNIQUE user_id BY country"
    ],
    "matchers": [
      { "kind": "include", "value": "\"count_unique_user_id\"" },
      { "kind": "include", "value": "\"NL\",1" },
      { "kind": "include", "value": "\"DE\",1" }
    ]
  }
  ,
  {
    "name": "agg_count_by_country",
    "input_commands": [
      "DEFINE login FIELDS { \"user_id\": \"string\", \"country\": \"string\" }",
      "STORE login FOR u1 PAYLOAD {\"user_id\":\"A\",\"country\":\"NL\"}",
      "STORE login FOR u2 PAYLOAD {\"user_id\":\"B\",\"country\":\"DE\"}",
      "STORE login FOR u3 PAYLOAD {\"user_id\":\"A\",\"country\":\"NL\"}",
      "FLUSH",
      "QUERY login COUNT user_id BY country"
    ],
    "matchers": [
      { "kind": "include", "value": "\"count_user_id\"" },
      { "kind": "include", "value": "\"NL\",2" },
      { "kind": "include", "value": "\"DE\",1" }
    ]
  }
  ,
  {
    "name": "agg_avg_total_min_max_per_month_by_country",
    "input_commands": [
      "DEFINE orders FIELDS { \"amount\": \"int\", \"country\": \"string\" }",
      "STORE orders FOR c1 PAYLOAD {\"amount\":10,\"country\":\"NL\"}",
      "STORE orders FOR c2 PAYLOAD {\"amount\":20,\"country\":\"NL\"}",
      "STORE orders FOR c3 PAYLOAD {\"amount\":15,\"country\":\"DE\"}",
      "FLUSH",
      "QUERY orders AVG amount, TOTAL amount, MIN amount, MAX amount PER month BY country"
    ],
    "matchers": [
      { "kind": "include", "value": "\"DE\",15.0,15,15,15" },
      { "kind": "include", "value": "\"NL\",15.0,30,10,20" }
    ]
  }
  ,
  {
    "name": "agg_multiple_ops_no_group",
    "input_commands": [
      "DEFINE evt FIELDS { \"x\": \"int\", \"y\": \"int\" }",
      "STORE evt FOR a PAYLOAD {\"x\":1,\"y\":2}",
      "STORE evt FOR b PAYLOAD {\"x\":3,\"y\":4}",
      "FLUSH",
      "QUERY evt AVG x, MIN y, MAX y, TOTAL x"
    ],
    "matchers": [
      { "kind": "include", "value": "\"rows\":[[2.0,2,4,4]]" }
    ]
  }
  ,
  {
    "name": "agg_count_only_with_filter",
    "input_commands": [
      "DEFINE evt FIELDS { \"kind\": \"string\" }",
      "STORE evt FOR k1 PAYLOAD {\"kind\":\"a\"}",
      "STORE evt FOR k2 PAYLOAD {\"kind\":\"b\"}",
      "STORE evt FOR k3 PAYLOAD {\"kind\":\"a\"}",
      "FLUSH",
      "QUERY evt WHERE kind=\"a\" COUNT"
    ],
    "matcher": { "kind": "include", "value": "\"rows\":[[2]]" }
  },
  {
    "name": "enum_store_wrong_case_rejected",
    "input_commands": [
      "DEFINE plan_change FIELDS { \"plan\": [\"pro\", \"basic\"] }",
      "STORE plan_change FOR u1 PAYLOAD {\"plan\": \"Pro\"}"
    ],
    "matcher": {
      "kind": "include",
      "value": "does not match expected type"
    }
  },
  {
    "name": "enum_query_wrong_case_returns_no_results",
    "input_commands": [
      "DEFINE plan_change FIELDS { \"plan\": [\"pro\", \"basic\"] }",
      "STORE plan_change FOR u1 PAYLOAD {\"plan\": \"pro\"}",
      "FLUSH",
      "QUERY plan_change WHERE plan=\"Pro\""
    ],
    "matcher": {
      "kind": "include",
      "value": "No matching events found"
    }
  },
  {
    "name": "ebm_eq_logs_pruning",
    "input_commands": [
      "DEFINE subscription FIELDS { \"plan\": [\"free\", \"pro\", \"premium\", \"enterprise\"] }",
      "STORE subscription FOR ctx1 PAYLOAD {\"plan\": \"free\"}",
      "STORE subscription FOR ctx2 PAYLOAD {\"plan\": \"pro\"}",
      "STORE subscription FOR ctx3 PAYLOAD {\"plan\": \"premium\"}",
      "STORE subscription FOR ctx4 PAYLOAD {\"plan\": \"enterprise\"}",
      "FLUSH",
      "QUERY subscription WHERE plan = \"pro\" OR plan = \"premium\""
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "ctx2",
          "ctx3"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "ctx1",
          "ctx4"
        ]
      }
    ]
  },
  {
    "name": "ebm_neq_logs_pruning",
    "input_commands": [
      "DEFINE subscription FIELDS { \"plan\": [\"free\", \"pro\", \"premium\", \"enterprise\"] }",
      "STORE subscription FOR ctx1 PAYLOAD {\"plan\": \"free\"}",
      "STORE subscription FOR ctx2 PAYLOAD {\"plan\": \"pro\"}",
      "STORE subscription FOR ctx3 PAYLOAD {\"plan\": \"premium\"}",
      "STORE subscription FOR ctx4 PAYLOAD {\"plan\": \"enterprise\"}",
      "FLUSH",
      "QUERY subscription WHERE plan != \"pro\""
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "ctx1",
          "ctx3",
          "ctx4"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "ctx2"
        ]
      }
    ]
  },
  {
    "name": "ebm_unknown_variant_no_results",
    "input_commands": [
      "DEFINE subscription FIELDS { \"plan\": [\"free\", \"pro\", \"premium\", \"enterprise\"] }",
      "STORE subscription FOR u1 PAYLOAD {\"plan\": \"free\"}",
      "STORE subscription FOR u2 PAYLOAD {\"plan\": \"pro\"}",
      "FLUSH",
      "QUERY subscription WHERE plan = \"unknown\""
    ],
    "matcher": {
      "kind": "include",
      "value": "No matching events found"
    }
  },
  {
    "name": "ebm_eq_across_two_zones",
    "input_commands": [
      "DEFINE subscription FIELDS { \"plan\": [\"free\", \"pro\", \"premium\", \"enterprise\"] }",
      "STORE subscription FOR ctx1 PAYLOAD {\"plan\": \"free\"}",
      "STORE subscription FOR ctx2 PAYLOAD {\"plan\": \"pro\"}",
      "STORE subscription FOR ctx3 PAYLOAD {\"plan\": \"premium\"}",
      "STORE subscription FOR ctx4 PAYLOAD {\"plan\": \"enterprise\"}",
      "STORE subscription FOR ctx5 PAYLOAD {\"plan\": \"pro\"}",
      "STORE subscription FOR ctx6 PAYLOAD {\"plan\": \"free\"}",
      "STORE subscription FOR ctx7 PAYLOAD {\"plan\": \"pro\"}",
      "STORE subscription FOR ctx8 PAYLOAD {\"plan\": \"premium\"}",
      "STORE subscription FOR ctx9 PAYLOAD {\"plan\": \"pro\"}",
      "FLUSH",
      "QUERY subscription WHERE plan = \"pro\""
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "ctx2",
          "ctx5",
          "ctx7",
          "ctx9"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "ctx1",
          "ctx3",
          "ctx4",
          "ctx6",
          "ctx8"
        ]
      }
    ]
  }
  ,
  {
    "name": "query_hits_memtable_only",
    "config": {
      "engine": { "flush_threshold": 100 }
    },
    "input_commands": [
      "DEFINE hot_path FIELDS { \"device\": \"string\" }",
      "STORE hot_path FOR u1 PAYLOAD {\"device\":\"android\"}",
      "STORE hot_path FOR u2 PAYLOAD {\"device\":\"iphone\"}",
      "STORE hot_path FOR u3 PAYLOAD {\"device\":\"android\"}",
      "QUERY hot_path WHERE device=\"android\""
    ],
    "matchers": [
      {
        "kind": "include_all",
        "value": [
          "u1",
          "u3"
        ]
      },
      {
        "kind": "include_none",
        "value": [
          "u2"
        ]
      }
    ]
  }
  ,
  {
    "name": "query_hits_passive_memtable",
    "config": {
      "engine": { "flush_threshold": 1 }
    },
    "input_commands": [
      "DEFINE warm_path FIELDS { \"device\": \"string\" }",
      "STORE warm_path FOR u1 PAYLOAD {\"device\":\"android\"}",
      "QUERY warm_path WHERE device=\"android\""
    ],
    "matcher": {
      "kind": "include_all",
      "value": [
        "u1"
      ]
    }
  },
  {
    "name": "wal_reload_after_restart",
    "config": { "engine": { "flush_threshold": 100 }, "wal": { "enabled": true } },
    "input_commands": [
      "DEFINE login FIELDS { \"device\": \"string\" }",
      "STORE login FOR u1 PAYLOAD {\"device\":\"android\"}",
      "SLEEP 100",
      "RESTART",
      "SLEEP 100",
      "QUERY login WHERE device=\"android\""
    ],
    "matcher": { "kind": "include_all", "value": ["u1"] }
  }
  ,
  {
    "name": "wal_recover_no_flush",
    "config": { "engine": { "flush_threshold": 100 }, "wal": { "enabled": true } },
    "input_commands": [
      "DEFINE login FIELDS { \"device\": \"string\" }",
      "STORE login FOR u1 PAYLOAD {\"device\":\"android\"}",
      "SLEEP 100",
      "RESTART",
      "SLEEP 100",
      "QUERY login WHERE device=\"android\""
    ],
    "matcher": { "kind": "include_all", "value": ["u1"] }
  }
  ,
  {
    "name": "wal_disabled_no_recovery",
    "config": { "engine": { "flush_threshold": 100 }, "wal": { "enabled": false} },
    "input_commands": [
      "DEFINE login FIELDS { \"device\": \"string\" }",
      "STORE login FOR u1 PAYLOAD {\"device\":\"android\"}",
      "SLEEP 100",
      "RESTART",
      "SLEEP 100",
      "QUERY login WHERE device=\"android\""
    ],
    "matcher": { "kind": "include", "value": "No matching events found" }
  }
  ,
  {
    "name": "wal_multi_log_recovery",
    "config": { "engine": { "flush_threshold": 2 }, "wal": { "enabled": true } },
    "input_commands": [
      "DEFINE evt FIELDS { \"v\": \"int\" }",
      "STORE evt FOR a PAYLOAD {\"v\":1}",
      "STORE evt FOR b PAYLOAD {\"v\":2}",
      "STORE evt FOR c PAYLOAD {\"v\":3}",
      "SLEEP 100",
      "RESTART",
      "SLEEP 100",
      "QUERY evt WHERE v>=1"
    ],
    "matcher": { "kind": "include_all", "value": ["a","b","c"] }
  }
  ,
  {
    "name": "wal_recover_during_pending_flush",
    "config": { "engine": { "flush_threshold": 1 }, "wal": { "enabled": true } },
    "input_commands": [
      "DEFINE evt FIELDS { \"v\": \"int\" }",
      "STORE evt FOR a PAYLOAD {\"v\":1}",
      "SLEEP 100",
      "RESTART",
      "SLEEP 100",
      "QUERY evt WHERE v=1"
    ],
    "matcher": { "kind": "include_all", "value": ["a"] }
  }
  ,
  {
    "name": "wal_flush_then_restart_segment_only",
    "config": { "engine": { "flush_threshold": 2 }, "wal": { "enabled": true } },
    "input_commands": [
      "DEFINE order FIELDS { \"id\": \"int\" }",
      "STORE order FOR c1 PAYLOAD {\"id\":1}",
      "STORE order FOR c2 PAYLOAD {\"id\":2}",
      "SLEEP 200",
      "RESTART",
      "SLEEP 200",
      "QUERY order WHERE id>=1"
    ],
    "matcher": { "kind": "include_all", "value": ["c1","c2"] }
  }
  ,
  {
    "name": "wal_recover_multi_shard",
    "config": { "engine": { "flush_threshold": 100, "shard_count": 2 }, "wal": { "enabled": true } },
    "input_commands": [
      "DEFINE ping FIELDS { \"x\": \"int\" }",
      "STORE ping FOR shard-a PAYLOAD {\"x\":1}",
      "STORE ping FOR shard-b PAYLOAD {\"x\":2}",
      "SLEEP 100",
      "RESTART",
      "SLEEP 100",
      "QUERY ping WHERE x>=1"
    ],
    "matcher": { "kind": "include_all", "value": ["shard-a","shard-b"] }
  }
  ,
  {
    "name": "wal_durable_flush_each_write",
    "config": {
      "engine": { "flush_threshold": 100 },
      "wal": { "enabled": true, "buffered": true, "flush_each_write": true, "fsync": false }
    },
    "input_commands": [
      "DEFINE login FIELDS { \"device\": \"string\" }",
      "STORE login FOR u1 PAYLOAD {\"device\":\"android\"}",
      "SLEEP 10",
      "RESTART",
      "SLEEP 10",
      "QUERY login WHERE device=\"android\""
    ],
    "matcher": { "kind": "include_all", "value": ["u1"] }
  }
  ,
  {
    "name": "wal_fsync_every_n_without_flush_each_write",
    "config": {
      "engine": { "flush_threshold": 100 },
      "wal": { "enabled": true, "buffered": true, "flush_each_write": false, "fsync": true, "fsync_every_n": 1 }
    },
    "input_commands": [
      "DEFINE evt FIELDS { \"v\": \"int\" }",
      "STORE evt FOR u1 PAYLOAD {\"v\":1}",
      "SLEEP 10",
      "RESTART",
      "SLEEP 10",
      "QUERY evt WHERE v=1"
    ],
    "matcher": { "kind": "include", "value": "No matching events found" }
  }
  ,
  {
    "name": "query_order_by_asc_with_limit",
    "input_commands": [
      "DEFINE score FIELDS { \"val\": \"int\" }",
      "STORE score FOR u1 PAYLOAD {\"val\":50}",
      "STORE score FOR u2 PAYLOAD {\"val\":30}",
      "STORE score FOR u3 PAYLOAD {\"val\":70}",
      "STORE score FOR u4 PAYLOAD {\"val\":10}",
      "STORE score FOR u5 PAYLOAD {\"val\":90}",
      "FLUSH",
      "QUERY score ORDER BY val ASC LIMIT 3"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"val\":10", "\"val\":30", "\"val\":50"] },
      { "kind": "include_none", "value": ["\"val\":70", "\"val\":90"] }
    ]
  }
  ,
  {
    "name": "query_order_by_desc_with_limit",
    "input_commands": [
      "DEFINE score FIELDS { \"val\": \"int\" }",
      "STORE score FOR u1 PAYLOAD {\"val\":50}",
      "STORE score FOR u2 PAYLOAD {\"val\":30}",
      "STORE score FOR u3 PAYLOAD {\"val\":70}",
      "STORE score FOR u4 PAYLOAD {\"val\":10}",
      "STORE score FOR u5 PAYLOAD {\"val\":90}",
      "FLUSH",
      "QUERY score ORDER BY val DESC LIMIT 2"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"val\":90", "\"val\":70"] },
      { "kind": "include_none", "value": ["\"val\":50", "\"val\":30", "\"val\":10"] }
    ]
  }
  ,
  {
    "name": "query_order_by_with_offset_and_limit",
    "input_commands": [
      "DEFINE price FIELDS { \"val\": \"int\" }",
      "STORE price FOR p1 PAYLOAD {\"val\":100}",
      "STORE price FOR p2 PAYLOAD {\"val\":200}",
      "STORE price FOR p3 PAYLOAD {\"val\":300}",
      "STORE price FOR p4 PAYLOAD {\"val\":400}",
      "STORE price FOR p5 PAYLOAD {\"val\":500}",
      "FLUSH",
      "QUERY price ORDER BY val ASC OFFSET 1 LIMIT 3"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"val\":200", "\"val\":300", "\"val\":400"] },
      { "kind": "include_none", "value": ["\"val\":100", "\"val\":500"] }
    ]
  }
  ,
  {
    "name": "query_order_by_desc_with_offset",
    "input_commands": [
      "DEFINE rating FIELDS { \"val\": \"int\" }",
      "STORE rating FOR r1 PAYLOAD {\"val\":5}",
      "STORE rating FOR r2 PAYLOAD {\"val\":10}",
      "STORE rating FOR r3 PAYLOAD {\"val\":15}",
      "STORE rating FOR r4 PAYLOAD {\"val\":20}",
      "STORE rating FOR r5 PAYLOAD {\"val\":25}",
      "FLUSH",
      "QUERY rating ORDER BY val DESC OFFSET 2 LIMIT 2"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"val\":15", "\"val\":10"] },
      { "kind": "include_none", "value": ["\"val\":25", "\"val\":20", "\"val\":5"] }
    ]
  }
  ,
  {
    "name": "query_offset_without_limit_rejected",
    "input_commands": [
      "DEFINE evt FIELDS { \"val\": \"int\" }",
      "STORE evt FOR e1 PAYLOAD {\"val\":1}",
      "STORE evt FOR e2 PAYLOAD {\"val\":2}",
      "FLUSH",
      "QUERY evt ORDER BY val ASC OFFSET 1"
    ],
    "matcher": { "kind": "include", "value": "OFFSET requires LIMIT" }
  }
  ,
  {
    "name": "query_order_by_string_field_asc",
    "input_commands": [
      "DEFINE user FIELDS { \"name\": \"string\" }",
      "STORE user FOR u1 PAYLOAD {\"name\":\"charlie\"}",
      "STORE user FOR u2 PAYLOAD {\"name\":\"alice\"}",
      "STORE user FOR u3 PAYLOAD {\"name\":\"bob\"}",
      "FLUSH",
      "QUERY user ORDER BY name ASC LIMIT 2"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["alice", "bob"] },
      { "kind": "include_none", "value": ["charlie"] }
    ]
  }
  ,
  {
    "name": "query_order_by_with_filter",
    "input_commands": [
      "DEFINE item FIELDS { \"category\": \"string\", \"price\": \"int\" }",
      "STORE item FOR i1 PAYLOAD {\"category\":\"A\",\"price\":100}",
      "STORE item FOR i2 PAYLOAD {\"category\":\"A\",\"price\":200}",
      "STORE item FOR i3 PAYLOAD {\"category\":\"B\",\"price\":150}",
      "STORE item FOR i4 PAYLOAD {\"category\":\"A\",\"price\":50}",
      "FLUSH",
      "SLEEP 400",
      "QUERY item WHERE category=\"A\" ORDER BY price ASC LIMIT 2"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"price\":50", "\"price\":100"] },
      { "kind": "include_none", "value": ["\"price\":200", "\"price\":150"] }
    ]
  }
  ,
  {
    "name": "query_order_by_offset_boundary",
    "input_commands": [
      "DEFINE num FIELDS { \"val\": \"int\" }",
      "STORE num FOR n1 PAYLOAD {\"val\":1}",
      "STORE num FOR n2 PAYLOAD {\"val\":2}",
      "STORE num FOR n3 PAYLOAD {\"val\":3}",
      "FLUSH",
      "QUERY num ORDER BY val ASC OFFSET 2 LIMIT 5"
    ],
    "matchers": [
      { "kind": "include", "value": "\"val\":3" },
      { "kind": "include_none", "value": ["\"val\":1", "\"val\":2"] }
    ]
  }
  ,
  {
    "name": "query_order_by_memtable_and_segment",
    "input_commands": [
      "DEFINE mixed FIELDS { \"val\": \"int\" }",
      "STORE mixed FOR m1 PAYLOAD {\"val\":10}",
      "STORE mixed FOR m2 PAYLOAD {\"val\":20}",
      "FLUSH",
      "STORE mixed FOR m3 PAYLOAD {\"val\":5}",
      "STORE mixed FOR m4 PAYLOAD {\"val\":15}",
      "QUERY mixed ORDER BY val ASC LIMIT 3"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"val\":5", "\"val\":10", "\"val\":15"] },
      { "kind": "include_none", "value": ["\"val\":20"] }
    ]
  }
  ,

  {
    "name": "query_order_by_large_offset",
    "config": { "engine": { "flush_threshold": 3 } },
    "input_commands": [
      "DEFINE large FIELDS { \"val\": \"int\" }",
      "STORE large FOR l1 PAYLOAD {\"val\":1}",
      "STORE large FOR l2 PAYLOAD {\"val\":2}",
      "STORE large FOR l3 PAYLOAD {\"val\":3}",
      "STORE large FOR l4 PAYLOAD {\"val\":4}",
      "STORE large FOR l5 PAYLOAD {\"val\":5}",
      "STORE large FOR l6 PAYLOAD {\"val\":6}",
      "FLUSH",
      "SLEEP 500",
      "QUERY large ORDER BY val ASC OFFSET 4 LIMIT 2"
    ],
    "matchers": [
      { "kind": "include_all", "value": ["\"val\":5", "\"val\":6"] },
      { "kind": "include_none", "value": ["\"val\":1", "\"val\":2", "\"val\":3", "\"val\":4"] }
    ]
  }
]